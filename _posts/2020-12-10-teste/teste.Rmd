---
title: "teste"
description: |
  A short description of the post.
author:
  - name: Lucas Moraes
    url: https://lucasmoraes.io
date: 12-10-2020
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

Pequeno estudo de caso fazendo uso de modelos de regressão linear simples bivariada.

Para fazer essa análise, vou usar o dataset [`Fish`](https://www.kaggle.com/aungpyaeap/fish-market) quem contém diferentes medidas de peixes registrados em um mercado.

Meu objetivo aqui vai ser escolher uma variável de resposta e a melhor variável que explique seu comportamento.

Primeiro vou dar uma olhada no dataset, já carregando alguns pacotes que vou utilizar:

```{r}
library(rmarkdown)
library(tidyverse) 
library(broom)
library(car)
library(ggExtra)


paged_table( 
fish <- read_csv("https://www.dropbox.com/s/n45vml0ayoq0omx/fish.csv?dl=1")
)
```
Os nomes de coluna não são muito intuitivos, então vou descrever cada um:

1. `Species`: nome da espécie mensurada.
2. `Weight`: Peso do peixe em gramas.
3. `Length1`: comprimento vertical em cm.
4. `Length2`: comprimento diagonal em cm.
5. `Length3`: comprimento cruzado em cm.
6. `Height`: altura em cm.
7. `Width`: largura diagonal em cm.

Vou definir como minha variável de resposta o peso do peixe, esse é o valor que quero prever em função das demais variáveis explicativas. Para dar início à análise, entao, vou plotar a correlacao de minha varável de resposta com todas as demais variáveis explanatórias e calcular o $R^2$ de cada caso.

Para plotar tudo de uma vez preciso alterar um pouco a tabela:

```{r}
fish %>% # alterando a disposição de colunas para a plotagem
  pivot_longer(cols=names(fish)[3:length(names(fish))],names_to = "explanatory") %>% 
  # plotagem
  ggplot(aes(y=Weight,x=value)) + geom_point() + geom_smooth(method="lm",linetype=2) +
  theme_bw() +
  ggtitle("Peso vs. altura, medidas de comprimento e largura.") +
  ylab("Peso - variável de resposta") +
  xlab("Variáveis explanatórias, em escala livre.") +
  facet_wrap(~explanatory, scales="free")
```
Dá para perceber que a correlação do peso com as demais medidas é positiva em todos casos, em alguns mais e outros menos, pela inclinação das retas de regressão (tracejadas azuis). Entretanto, fica difícil entender a robustez dos modelos (na forma de $R^2$) visualmente. Portanto, vou computar esses valores em uma tabela e ordenar em ordem decrescente:

```{r}
# função para extrair o r2 dos modelos
rsquared_mod <- function(x) {
  return(
    summary( 
    lm(paste0("Weight ~", x), data = fish)
    )[["r.squared"]]
  )
}

# lista de variaveis explanatorias que vou cruzar com o peso
explanatory <- names(fish)[3:length(names(fish))]

# tabela com valores de r2 dos modelos em ordem decrescente

tibble(variables=explanatory,r_squared=unlist(map(explanatory,rsquared_mod))) %>% 
    arrange(desc(r_squared))
```

Essa tabela me dá os valores de $R^2$ para cada modelo simples de peso e cada uma das outras variáveis independentemente (não sendo covariáveis). 

As três medidas de comprimento são as que melhor descrevem o comportamento do peso. A altura é a medida menos robusta e a largura fica no meio do caminho. Os valores altos dos modelos que levam em consideração os diferentes tipos de comprimento apontam para uma possível colinearidade entre essas variáveis. Isso significa que, em um modelo multivariado, essas medidas provavelmente seriam redundantes.

Vou desenvolver isso um pouco mais a frente, mas por hora, como vou fazer uma regressão simples, vou usar a variável `Length3` como explanatória, dado que ela resultou no maior valor de $R^2$.

Abaixo, os coeficientes do modelo:

```{r,preview=TRUE}
lm(Weight~Length3,data=fish)
```

Segundo esse modelo, existe um incremento de cerca de 28 gramas no peso de um peixe conforme a largura cruzada do peixe aumenta em uma unidade, ou seja, 1 centímetro.

Abaixo, vou plotar o gráfico da regressão, já atribuindo cores diferentes aos pontos para as diferentes espécies da amostra:


```{r,preview=TRUE}
library(paletteer) # pacote com paletas de cores

fish %>% ggplot(aes(y=Weight,x=Length3)) + 
  geom_point(alpha=0.7,aes(color=Species)) + 
  geom_smooth(method="lm", linetype=2) +
  theme_bw() +
  ylab("Peso (g)") +
  xlab("Comprimento cruzado (cm)") +
  labs(color='Espécie') +
  ggtitle(" Relação entre peso e comprimento cruzado,\n com cores referentes às espécies das observações.") +
  scale_color_paletteer_d("pals::alphabet") +
  theme(plot.title = element_text(size = 10))
```

Um fator interessante de se notar é a provável alta influência dos pontos associados à espécie Pike (em roxo), na inclinação e erro associado da reta, devido ao alto valor tanto de peso quanto de comprimento cruzado de alguns de seus pontos. Essa espécie provavelmente tem maiores valores, em média, de distância de cook para suas observações, o que vai influenciar no comportamento da reta. Podemos checar isso sumarizando o modelo e esses valores, por espécie:

